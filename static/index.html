<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Manuals QA</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--ink); }
  header { padding: 14px 18px; border-bottom:1px solid #1f2937; position: sticky; top:0; background:rgba(15,23,42,.8); backdrop-filter: blur(6px); }
  header h1 { margin:0; font-size:16px; letter-spacing:.3px; }
  main { max-width: 900px; margin: 18px auto; padding: 0 16px 120px; }
  .msg { background: var(--card); border:1px solid #1f2937; border-radius: 16px; padding: 14px 16px; margin: 12px 0; }
  .me { border-color:#0ea5e9; }
  .meta { font-size:12px; color: var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center;}
  .answer { white-space: pre-wrap; line-height:1.5; }
  .cites { margin-top:10px; font-size:13px; color: var(--muted); display:flex; flex-wrap: wrap; gap:8px; }
  .cite { display:inline-block; padding:2px 6px; border-radius: 12px; border:1px solid #374151; text-decoration:none; color:var(--muted); }
  .cite:hover { border-color:#22d3ee; color:#e5e7eb; }
  .footer { position: fixed; bottom: 0; left: 0; right: 0; background:rgba(15,23,42,.9); backdrop-filter: blur(6px); border-top:1px solid #1f2937; }
  form { max-width: 900px; margin: 12px auto; padding: 8px 16px 14px; display:flex; gap:10px; }
  textarea { flex:1; resize: vertical; min-height:52px; max-height:180px; border-radius:14px; padding:12px; border:1px solid #374151; background:#0b1220; color:var(--ink); }
  button { background: linear-gradient(135deg, #06b6d4, #22d3ee); color:#0b1220; border:0; padding: 0 16px; border-radius:12px; font-weight:600; cursor:pointer; }
  button[disabled]{opacity:.6; cursor:not-allowed;}
  .spinner { width:16px;height:16px;border:2px solid #1f2937;border-top-color:var(--accent);border-radius:50%;display:inline-block;animation:spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .tips { color: var(--muted); font-size: 13px; margin-top: 6px;}
</style>
</head>
<body>
  <header>
    <h1>ðŸ“˜ Manuals QA (local)</h1>
    <div class="tips">Answers are grounded in your <code>data/raw</code> docs with clickable citations.</div>
  </header>

  <main id="chat"></main>

  <div class="footer">
    <form id="ask-form">
      <textarea id="q" placeholder="Ask about your manualâ€¦ (e.g. 'How do I reset the device to factory settings?')"></textarea>
      <button id="send" type="submit">Ask</button>
    </form>
  </div>

<script>
const chat = document.getElementById('chat');
const form = document.getElementById('ask-form');
const q = document.getElementById('q');
const send = document.getElementById('send');

function addMessage(role, text, cites=[]) {
  const wrap = document.createElement('div');
  wrap.className = 'msg ' + (role === 'me' ? 'me' : 'bot');
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = role === 'me' ? 'You' : 'Assistant';
  const body = document.createElement('div');
  body.className = 'answer';
  body.textContent = text;
  wrap.appendChild(meta);
  wrap.appendChild(body);

  if (cites && cites.length) {
    const c = document.createElement('div');
    c.className = 'cites';
    for (const ci of cites) {
      const a = document.createElement('a');
      a.className = 'cite';
      a.href = ci.link || '#';
      a.target = '_blank';
      a.rel = 'noopener';
      a.textContent = `[${ci.n}] ${ci.section || ''} â€” ${ci.source}`;
      c.appendChild(a);
    }
    wrap.appendChild(c);
  }

  chat.appendChild(wrap);
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function addThinking() {
  const wrap = document.createElement('div');
  wrap.className = 'msg';
  wrap.id = 'thinking';
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.innerHTML = 'Assistant <span class="spinner"></span>';
  wrap.appendChild(meta);
  chat.appendChild(wrap);
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function removeThinking() {
  const t = document.getElementById('thinking');
  if (t) t.remove();
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const question = q.value.trim();
  if (!question) return;
  addMessage('me', question);
  q.value = '';
  send.disabled = true;
  addThinking();
  try {
    const resp = await fetch('/ask', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ question })
    });
    if (!resp.ok) {
      const errTxt = await resp.text();
      removeThinking();
      addMessage('bot', `Error: ${resp.status} ${errTxt}`);
      return;
    }
    const data = await resp.json();
    removeThinking();
    addMessage('bot', data.answer || '(no answer)', data.citations || []);
  } catch (err) {
    removeThinking();
    addMessage('bot', 'Network error. Is the API running?');
  } finally {
    send.disabled = false;
  }
});
</script>
</body>
</html>
